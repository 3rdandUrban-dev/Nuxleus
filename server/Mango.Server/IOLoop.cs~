

using System;
using System.Text;
using System.Net;
using System.Net.Sockets;

using Mono.Unix.Native;


public class T {

	public static void Main ()
	{
		int epfd = Syscall.epoll_create (24);

		TcpListener listener = new TcpListener (8080);
		listener.Start (); 

		Socket socket = new Socket (AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);

		socket.Bind (new IPEndPoint (IPAddress.Parse ("127.0.0.1"), 8081));
		socket.Listen (128);

		int res = Syscall.epoll_ctl (epfd, EpollOp.EPOLL_CTL_ADD, (int) socket.Handle, EpollEvents.EPOLLIN);

		Console.WriteLine ("entering epoll wait loop on handle: {0}", (int) socket.Handle);
		while (true) {
			// wait for something to do...
			var events = Syscall.epoll_wait (epfd, 1000);

			// for each ready socket	
			foreach (var e in events) {
				Console.WriteLine ("{0} {1}", e.Key, e.Value);

				Socket s = socket.Accept ();
				Syscall.epoll_ctl (epfd, EpollOp.EPOLL_CTL_ADD, (int) s.Handle, EpollEvents.EPOLLIN);
			}
		}
	}
}

