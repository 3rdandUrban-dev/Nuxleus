
using System;
using System.IO;
using System.Reflection;
using System.Collections.Generic;

using NUnit.Framework;


namespace Mango.Templates.Minge.Tests {

	public class MingeTest {

		public static string RenderString (string str, Dictionary<string,object> the_args=null)
		{
			string assembly_path = "test-bin/minge-test.dll";

			AppDomainSetup domain_setup = new AppDomainSetup () { ApplicationBase  = Directory.GetCurrentDirectory (), PrivateBinPath = "test-bin" };
			AppDomain test_domain = AppDomain.CreateDomain ("test_domain", null, domain_setup);

			Console.WriteLine ("RELATIVE SEARCH PATH:  {0}", test_domain.RelativeSearchPath);

			Console.WriteLine ("ASSEMBLY PATH:  {0}", assembly_path);

			Environment environment = new Environment ();
			Application app = new Application (environment, "minge-test", assembly_path);
			MingeParser p = new MingeParser (environment, app);

			MemoryStream the_stream = new MemoryStream (100);
			StreamWriter writer = new StreamWriter (the_stream);
			
			writer.Write (str);
			writer.Flush ();

			the_stream.Seek (0, SeekOrigin.Begin);
			p.ParsePage ("the_test_type", new StreamReader (the_stream));
			app.Save ();

			Assembly asm = test_domain.Load (assembly_path);
			Console.WriteLine ("LOADED ASSEMBLY:  {0}", assembly_path);
			Type template_type = asm.GetType ("templates.page_the_test_type");
			MethodInfo meth = template_type.GetMethod ("RenderToStream");
			object template = Activator.CreateInstance (template_type);

			MemoryStream stream = new MemoryStream ();
			writer = new StreamWriter (stream);

			if (the_args == null)
				the_args = new Dictionary<string,object> ();

			meth.Invoke (template, new object [] { writer, the_args });

			writer.Flush ();
			stream.Seek (0, SeekOrigin.Begin);

			StreamReader reader = new StreamReader (stream);

			string result = reader.ReadToEnd ();

			AppDomain.Unload (test_domain);
			return result;
		}

		static byte [] LoadAssembly (string path)
		{
			FileStream fs = new FileStream (path, FileMode.Open);
			byte [] buffer = new byte [(int) fs.Length];
			fs.Read (buffer, 0, buffer.Length);
			fs.Close ();

			return buffer;
		}
	}
}

